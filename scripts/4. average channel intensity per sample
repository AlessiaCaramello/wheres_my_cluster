##### Calculate average channel intensity per sample #####


### Input data: output files from "1. number of cells per cluster per sample"

# Input file should be in "tables" folder


### Run each section at a time

#### 0. Load libraries ####

library(stringr) 
library(tidyverse)
library(plyr)
library(readr)
library(stringr)
library("rqdatatable")
library(dplyr)
library(ggExtra)
library(gridExtra)
library(ggsignif)


#### 1. Load data from previous analysis ####

samples_all <- read.csv("tables/samples_all.csv")

#### 2. Define the columns to consider for analysis ####

markers_number <- readline("How many markers are you analysing?")  

#### 3. Calculate average intensity and save ####

# calculate average of column intensity (per sample)
avg_int <- aggregate(samples_all[, 4:(as.numeric(markers_number) + 3)], 
                     list(samples_all$sample_origin), mean)

# change name to first column
names(avg_int)[names(avg_int) == 'Group.1'] <- 'file_name'

# add two columns with sampleID and each replicate (taken from file_name)
avg_int$sampleID = str_extract(avg_int$file_name, "[^_]*_[^_]*")
avg_int$group = sub("_.*", "", avg_int$file_name)
avg_int$replicate = sub(".*_", "",avg_int$file_name)

# calculate average of column intensity (per group/sampleID)
avg_int_sample <- aggregate(avg_int[, 2:(as.numeric(markers_number) + 1)], 
                            list(avg_int$sampleID), mean)

# change name to first column
names(avg_int_sample)[names(avg_int_sample) == 'Group.1'] <- 'file_name'

# add column with experimental group 
avg_int_sample$group = sub("_.*", "", avg_int_sample$file_name)

# save csv 
write_csv(avg_int,'tables/channel_intensity_avg.csv')
write_csv(avg_int_sample,'tables/channel_intensity_avg_sample.csv')
